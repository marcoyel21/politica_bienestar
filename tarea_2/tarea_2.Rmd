---
output:
  pdf_document: default
geometry: margin=1in
fontsize: 11pt
header-includes :
  \usepackage{geometry}
  \usepackage{graphicx}
  \tolerance=1
  \hyphenpenalty=10000
  \hbadness=10000
  \linespread{1.3}
  \usepackage[justification=centering, font=bf, labelsep=period, skip=5pt]{caption} 
  \usepackage{titling}
  \usepackage[spanish]{babel}
  \usepackage{fancyhdr}
  \pagestyle{fancy}
  \fancyhead[L]{Maestría en Economía Aplicada}
  \fancyhead[R]{ITAM}
---
\begin{titlepage}
\begin{center}

\textsc{\Large Instituto Tecnológico Autónomo de México}\\[2em]

\textbf{\LARGE Bienestar y Política Social}\\[2em]


\textsc{\LARGE }\\[1em]


\textsc{\large Tarea 2 }\\[1em]

\textsc{\LARGE }\\[1em]

\textsc{\large }\\[1em]
\textsc{\LARGE }\\[1em]
\textsc{\LARGE }\\[1em]

\textsc{\large }\\[1em]
\textsc{\LARGE }\\[1em]

\textsc{\LARGE Dra. Araceli Ortega Díaz}\\[1em]

\textsc{\LARGE }\\[1em]
\textsc{\LARGE }\\[1em]

\textsc{\LARGE Marco Antonio Ramos Juárez}\\[1em]

\textsc{\large 142244}\\[1em]

\textsc{\LARGE Mayra Samantha Cervantes Bravo}\\[1em]

\textsc{\large 141371}\\[1em]

\textsc{\LARGE Cynthia Raquel Valdivia Tirado }\\[1em]

\textsc{\large 81358}\\[1em]

\end{center}

\vspace*{\fill}
\textsc{Ciudad de México \hspace*{\fill} 2021}

\end{titlepage}


\newpage


\tableofcontents

\newpage

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

#cargo librerias
library(dplyr)
library(ggplot2)
library(ggthemes)
library(kableExtra)

library(readr)
library(corrplot)

#importo los datos
data<-read_csv("muestra_idd.csv")


```

# Metodología.

El proposito de esta tarea es desarrollar un nuevo índice (con base en el trabajo existente del CONEVAL) que pueda focalizar a un grupo específico de la clase media, aquellos que solamente tienen pobreza de ingresos, es decir, que no presentan ninguna de las carencias que el CONEVAL incluye en su índice. Sin duda, este grupo es sumamente interesante y presenta un reto en cuanto a la focalización debido a dos razones: en primer lugar, debido a que es la población más pequeña dentro de los cuadrantes previamente delimitados por el CONEVAL; en segundo lugar, porque es un grupo con características que se podrían conceptualizar como contradictorias. 

Para abordar la investigación, se  exploraron las variables disponibles en las bases de datos pertinentes y se llevó a cabo una revisión breve de literatura acerca de la caracterización de este grupo. Esto con el fin de tener tanto una perspectiva estadística pero también teórica del grupo. Se realizó una breve síntesis de ambos hallazgos con el fin de obtener la selección de variables final. 

Posteriormente, se estimó un modelo logistico donde nuestra variable independiente es una variable dicotómica que indica la pertenencia al cuadrante 3, nuestra población objetivo, mientras que las regresoras fueron XXX. Por último, se realizó una matriz de confusión para comparar la clasificación del modelo propuesto contra la del CONEVAL. 

# Estadística descriptiva.

Primero se realizó un análisis de correlaciones entre la pertenencia a  esta "clase media" (vulnerable en ingresos pero no en carencias por derechos sociales) y variables que se consideraron relacionadas con esta situación, como relacionadas a contar con un seguro médico (directa o indirectamente), aspectos geográficos (tamaño de localidad, estado, entorno urbano y rural), económicos (ser parte de la PEA), ingreso del hogar, y carencias de combustible, educación, servicios básicos del hogar, etc.

Después de ver las correlaciones y después de revisar la literatura, se optó por el modelo ya mencionado, cuyas correlaciones con el "cuadrante 3" son las siguientes:
```{r}
cor_data2<-as.data.frame(cor(data))
cor_data_filtered<-cor_data2 %>%select(y_3)
kable(cor_data_filtered,"simple")
```
Donde las relaciones más claras son negativas con indicadores de carencias a servicios médicos y de educación. Como sabemos, esta población es vulnerable en ingresos, pero no en carencias en derechos sociales, por lo que este modelo parece adecuado. 

Para corroborar y ver con más detalle la relación entre los cuadrantes con las variables de interés dicotómicas (indicadores de carencias y accesos), generamos gráficos de barras mostrando al porcentaje de personas que sí o que no contaban con el atributo respectivo. Omitimos las gráficas de los indicadores de carencia por acceso a alimentación, a servicios de combustible, servicios básicos de vivienda y a servicios de salud; y a la carencia por rezago educativo debido a que el porcentaje de personas del cuadrante 3 con estas carencias era 0%, como se esperaba para este grupo.

```{r}
PlotXTabs(data,s_salud,cuadrantes,plottype = "percent")
PlotXTabs(data,jef_ss,cuadrantes,plottype = "percent")
PlotXTabs(data,ss_dir,cuadrantes,plottype = "percent")
PlotXTabs(data,tam_loc,cuadrantes,plottype = "percent")
```
Algunos aspectos que notamos del cuadrante 3 respecto a los otros son:
* Mayor proporción de su población viviendo en localidades de menos de 2500 habitantes (y rural)
* Antecedido por el cuadrante 1, tienen el mayor promedio de integrantes del hogar (4.1)
* No cuentan con carencias educativas ni de salud, y junto con el cuadrante 4 tienen la mayor proporción de acceso a servicios médicos. 
* La inseguridad alimentaria no es 0 pero es baja (respecto a los cuadrantes 1 y 2).
*Tienen el menor promedio de ingreso per cápita y del hogar.

Para corroborar el nivel de ingresos de este grupo, realizamos un gráfico de caja y brazos para comparar los ingresos monetarios de los hogares de los cuatro cuadrantes. Se obtuvo: 

```{r}
ggplot(data,aes(x=as.factor(cuadrantes), y=ing_mon, fill=as.factor(cuadrantes))) +
  geom_boxplot() +
  scale_fill_viridis(discrete = TRUE, alpha=0.6, option="A") +
  theme_ipsum() +
  theme(
    legend.position="none",
    plot.title = element_text(size=11)
  ) +
  ggtitle("Ingreso por Cuadrante") +
  xlab("")+
  ylim(0,35000)
```
Se puede observar que los ingresos son ligeramente mayores a los del grupo 1 (pobreza por ingresos y derechos sociales), con menor varianza. 

# Resultados.
#. Estimación de modelo

```{r}

logitMod <- glm(y_3 ~ ., data=data_filtered, family=binomial(link="logit"))


#Creo una función para generar matriz de confusión
confusion.glm <- function(data, model) {
  prediction <- ifelse(predict(model, data, type='response') > 0.5, TRUE, FALSE)
  confusion  <- table(prediction, as.logical(model$y))
  confusion  <- cbind(confusion, c(1 - confusion[1,1]/(confusion[1,1]+confusion[2,1]), 1 - confusion[2,2]/(confusion[2,2]+confusion[1,2])))
  confusion  <- as.data.frame(confusion)
  names(confusion) <- c('FALSE', 'TRUE', 'class.error')
  confusion
}

#Genero la matriz de confusión
confusion.glm(data_filtered,logitMod)

```
# Comparación.

# Conclusiones.

