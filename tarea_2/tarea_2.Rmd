---
output:
  pdf_document: default
geometry: margin=1in
fontsize: 11pt
header-includes :
  \usepackage{geometry}
  \usepackage{graphicx}
  \tolerance=1
  \hyphenpenalty=10000
  \hbadness=10000
  \linespread{1.3}
  \usepackage[justification=centering, font=bf, labelsep=period, skip=5pt]{caption} 
  \usepackage{titling}
  \usepackage[spanish]{babel}
  \usepackage{fancyhdr}
  \pagestyle{fancy}
  \fancyhead[L]{Maestría en Economía Aplicada}
  \fancyhead[R]{ITAM}
---
\begin{titlepage}
\begin{center}

\textsc{\Large Instituto Tecnológico Autónomo de México}\\[2em]

\textbf{\LARGE Bienestar y Política Social}\\[2em]


\textsc{\LARGE }\\[1em]


\textsc{\large Tarea 2 }\\[1em]

\textsc{\LARGE }\\[1em]

\textsc{\large }\\[1em]
\textsc{\LARGE }\\[1em]
\textsc{\LARGE }\\[1em]

\textsc{\large }\\[1em]
\textsc{\LARGE }\\[1em]

\textsc{\LARGE Dra. Araceli Ortega Díaz}\\[1em]

\textsc{\LARGE }\\[1em]
\textsc{\LARGE }\\[1em]

\textsc{\LARGE Marco Antonio Ramos Juárez}\\[1em]

\textsc{\large 142244}\\[1em]

\textsc{\LARGE Mayra Samantha Cervantes Bravo}\\[1em]

\textsc{\large 141371}\\[1em]

\textsc{\LARGE Cynthia Raquel Valdivia Tirado }\\[1em]

\textsc{\large 81358}\\[1em]

\end{center}

\vspace*{\fill}
\textsc{Ciudad de México \hspace*{\fill} 2021}

\end{titlepage}


\newpage


\tableofcontents

\newpage

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,warning = FALSE,fig.pos = 'H')

#paquetes marco
library(dplyr)
library(ggplot2)
library(ggthemes)
library(kableExtra)
library(readr)


#paquetes sam
library(readr)
library(dplyr)
library(splitstackshape)
library(ggplot2)
library(viridis)
library(viridisLite)
library(hrbrthemes)
library(tidyr)
library(table1)
library(kableExtra)

#importo los datos
data<-read_csv("muestra_idd.csv")


```

# Metodología.

El proposito de esta tarea es desarrollar un nuevo índice (con base en el trabajo existente del CONEVAL) que pueda focalizar a un grupo específico de la clase media: aquellos que solamente tienen pobreza de ingresos y que no presentan ninguna de las carencias que el CONEVAL incluye en su índice. Sin duda, este grupo es sumamente interesante y presenta un reto en cuanto a la focalización debido a dos razones: en primer lugar, debido a que es la población más pequeña dentro de los cuadrantes previamente delimitados por el CONEVAL; en segundo lugar, porque es un grupo con características que se podrían conceptualizar como contradictorias. 

Para abordar la investigación, se  exploraron las variables disponibles en las bases de datos pertinentes y se llevó a cabo una revisión breve de literatura acerca de la caracterización de este grupo. Esto con el fin de tener tanto una perspectiva estadística pero también teórica del grupo. Se realizó una breve síntesis de ambos hallazgos con el fin de obtener la selección de variables final. 

Posteriormente, se estimó un modelo logistico donde nuestra variable independiente es una variable dicotómica que indica la pertenencia al cuadrante 3, nuestra población objetivo, mientras que las regresoras fueron XXX. Por último, se realizó una comparación con la clasificación realizada por el CONEVAL. 

# Estadística descriptiva.

En primer lugar exploraremos el nivel de ingresos de este grupo. Para ello, realizamos un gráfico de caja y brazos para comparar los ingresos monetarios de los hogares de los cuatro cuadrantes.

```{r, out.width= "60%",fig.align = 'center'}
ggplot(data,aes(x=as.factor(cuadrantes), y=ing_mon, fill=as.factor(cuadrantes))) +
  geom_boxplot() +
  scale_fill_viridis(discrete = TRUE, alpha=0.6, option="A") +
  theme(
    legend.position="none",
    plot.title = element_text(size=11)
  ) +
  ggtitle("Ingreso monetario de los hogares por Cuadrante") +
  ylim(0,35000)
```

Esta gráfica es muy reveladora porque muestra que el promedio del ingreso monetario del grupo 3 es menor al del grupo 2. Es decir que a pesar de las carencias de los hogares en el grupo dos, estos hogares tienen un mayor ingreso monetario en promedio.

Asimismo, para ver con más detalle la relación entre los cuadrantes con variables de interés dicotómicas (indicadores de carencias y accesos), generamos gráficos de barras mostrando al porcentaje de personas que sí o que no contaban con el atributo respectivo.^[En esta sección omitimos las gráficas de los indicadores de carencia por acceso a alimentación, a servicios de combustible, servicios básicos de vivienda y a servicios de salud; y a la carencia por rezago educativo debido a que el porcentaje de personas del cuadrante 3 con estas carencias era 0%, como se esperaba para este grupo.]

```{r, out.width= "60%",fig.align = 'center'}

data %>% ggplot(aes(x=factor(cuadrantes),fill=factor(s_salud)))+geom_bar(position = "fill")+scale_y_continuous(name="%",labels=scales::percent)+labs(title="Servicios médicos",x="Cuadrante", y="%")
data %>% ggplot(aes(x=factor(cuadrantes),fill=factor(jef_ss)))+geom_bar(position = "fill")+scale_y_continuous(name="%",labels=scales::percent)+labs(title="Acceso a seguro social por jefatura",x="Cuadrante", y="%")
data %>% ggplot(aes(x=factor(cuadrantes),fill=factor(ss_dir)))+geom_bar(position = "fill")+scale_y_continuous(name="%",labels=scales::percent)+labs(title="Acceso directo a seguro social",x="Cuadrante", y="%")
data %>% ggplot(aes(x=factor(cuadrantes),fill=factor(tam_loc)))+geom_bar(position = "fill")+scale_y_continuous(name="%",labels=scales::percent)+labs(title="Tamaño de localidad",x="Cuadrante", y="%")

```

En resumen, algunos aspectos que notamos del cuadrante 3 respecto a los otros son:

* Habitan en localidads grandes y en general el patrón del tamaño de localidades se asemeja mucho al del cuadrante más rico en lugar de al de los cuadrantes 1 y 2. #cambiosam(la variable esta alrevez , 1 a 4 va de mayor a menor tamaño (yase, se mamaron))
* Antecedido por el cuadrante 1, tienen el mayor promedio de integrantes del hogar (4.1)
* No cuentan con carencias educativas ni de salud, y junto con el cuadrante 4 tienen la mayor proporción de acceso a servicios médicos. 
* La inseguridad alimentaria no es 0 pero es baja (respecto a los cuadrantes 1 y 2).
*Tienen el menor promedio de ingreso per cápita y del hogar.


Finalmente, se realizó un análisis de correlaciones entre la pertenencia a esta "clase media" (vulnerable en ingresos pero no en carencias por derechos sociales) y variables que se consideraron relacionadas con esta situación, como relacionadas a contar con un seguro médico (directa o indirectamente), aspectos geográficos (tamaño de localidad, estado, entorno urbano y rural), económicos (ser parte de la PEA), ingreso del hogar, y carencias de combustible, educación, servicios básicos del hogar, etc. 


# Resultados.

Con base en el análisis estadístico y la revisión de literatura, propusimos un nuevo índice compuesto por las siguientes variables dicotómicas y una categórica (localidad):

```{r}


A<-c("Ingreso","plb","Población con un ingreso menor a la línea de bienestar")
B<-c("Salud","s_salud","Servicios médicos por otros núcleos familiares o por contratación propia")
C<-c("Seguridad Social","jef_ss", "Acceso a seguridad social por parte del jefe de familia")
D<-c("Localidad","tam_loc", "Tamaño de la localidad (de mayor a menor)")
E<-c("Educación","ic_rezedu", "Indicador de rezago educativo")
F<-c("Alimentacion","ic_ali", "Indicador de carencia alimenticia")
G<-c("Energia","isb_combus", "Indicador de carencia de servicios de combustible")
H<-c("Servicios básicos","ic_sbv", "Indicador de carencia de acceso a servicios básicos en la vivienda")
I<-c("Vivienda","ic_cv", "Indicador de carencia por calidad y espacios de la vivienda")

kable(t(data.frame(A,B,C,D,E,F,G,H,I)),booktabs=T, row.names = NA, 
  col.names = c("Tipo","Nombre","Descripción"))%>% 
  kable_styling(latex_options="scale_down")

```

Asimismo, con dichas variables procedimos a estimar el respectivo modelo logístico

$$ln(\frac{P(X)}{1-P(X)}) = \beta_0+\beta_1A+\beta_2B+\beta_3C+\beta_4D+\beta_5E+\beta_6F+\beta_7G+\beta_8H+\beta_9I$$

Para probar el nivel de focalización, comparo la precisión de mi modelo con base en la clasificación del coneval.

```{r}
data_filtered<-data%>%select(y_3,
                             plb, s_salud, jef_ss,ss_dir,
                              ic_sbv,tam_loc ,ic_rezedu, 
                                ic_cv,isb_combus,ic_ali)
data_filtered$tam_loc<-as.factor(data_filtered$tam_loc)

logitMod <- glm(y_3 ~ ., data=data_filtered, family=binomial(link="logit"))


#Creo una función para generar matriz de confusión
confusion.glm <- function(data, model) {
  prediction <- ifelse(predict(model, data, type='response') > 0.5, TRUE, FALSE)
  confusion  <- table(prediction, as.logical(model$y))
  confusion  <- cbind(confusion, c(1 - confusion[1,1]/(confusion[1,1]+confusion[2,1]), 1 - confusion[2,2]/(confusion[2,2]+confusion[1,2])))
  confusion  <- as.data.frame(confusion)
  names(confusion) <- c('FALSE', 'TRUE', 'class.error')
  confusion
}



```
# Comparación.

Finalmente, realizamos una comparación de la focalización que logra nuestro indice comparando con la clasificación original del coneval.


```{r, results='asis'}

kable(as.data.frame(confusion.glm(data_filtered,logitMod)),booktabs=T, caption= "Matriz de confusión") %>%
  kable_styling(position = "center") %>%
  kableExtra::kable_styling(latex_options = "hold_position")


x<-c("99.2%","0.8%","94%")
y<-c("0.8%","99.2%","6%")
z<-c("93%","7%","")

tabla_2<-t(data.frame(x,y,z))

rownames(tabla_2) <- c("No grupo 3","Grupo 3","Total")

kable(tabla_2,booktabs=T, 
  col.names = c("No grupo 3","Grupo 3","Total"), caption = "Proporciones en focalización") %>%
  kable_styling(position = "center") %>%
  kableExtra::kable_styling(latex_options = "hold_position")

```

# Conclusiones.

La población que se estudió, la perteneciente al cuadrante 3 de la clasificación de pobreza del CONEVAL, tiene una pobreza por ingresos, pero no por derechos sociales. En el primer aspecto se asemeja al 1° grupo, en lo segundo llega a niveles parecidos a los del 4°. Es difícil ubicarlos como clase baja, media, o alta, pero dadas sus características la clase media es más adecuada: es una población mayoritariamente urbana, con acceso a servicios de salud y sin rezago educativa, algo de lo que el cuadrante 1 no se puede jactar.

Para comparar el índice propuesto con el del CONEVAL se optó por un logit. Este tenía como variable dependiente a una dummy que indicaba la pertenencia a este cuadrante (1) con la no pertenencia, usando a los otros indicadores como regresoras. 

Dado lo que encontramos, el índice propuesto hace una focalización bastante acertada, ya que se aproxima a la del CONEVAL. Esto se puede observar en la matriz de confusión, ya que la coincidencia de clasificación de personas del cuadrante 3 vs. de otros cuadrantes es casi 100% acertada. 


Este grupo es una fracción pequeña de la población mexicana, compuesta solo del 7%. Sin embargo, no debe ser desdeñada en la planeación y ejecución de los programas sociales, usualmente concentrados en atacar los niveles más fuertes de pobreza. Aunque cuenten con acceso a servicios básicos de salud, educación, y servicios básicos de vivienda, cuentan con un grado leve de inseguridad alimentaria, ingreso per cápita y familiar muy bajo, y el 48% es parte de la PNEA. 




